#!/bin/sh
# VPN/Zapret Web Control Panel — Multi-Profile
# Real tables: ip proxy_tproxy (chain prerouting), inet proxy_route (chain forward_zapret)

STATE_FILE="/etc/vpn_state.json"
NAMES_FILE="/etc/device_names.json"
PROFILES_FILE="/etc/vless_profiles.json"
TEMPLATES_DIR="/etc/sing-box/templates"
LAN_IFACE=$(cat /etc/vpn_lan_iface 2>/dev/null || echo "br-lan")
ROUTER_IP=$(uci get network.lan.ipaddr 2>/dev/null || echo "192.168.1.1")

CUSTOM_RULES_FILE="/etc/sing-box/custom_rules.json"

[ -f "$STATE_FILE" ] || echo '{}' > "$STATE_FILE"
[ -f "$NAMES_FILE" ] || echo '{}' > "$NAMES_FILE"
[ -f "$PROFILES_FILE" ] || echo '{"profiles":[],"default_profile_id":"","next_port":12345,"next_id":1}' > "$PROFILES_FILE"
[ -f "$CUSTOM_RULES_FILE" ] || echo '{"direct":[],"vpn":[]}' > "$CUSTOM_RULES_FILE"

# ===== Profile helpers =====

get_all_servers() {
    grep -o '"server":"[^"]*"' "$PROFILES_FILE" | sed 's/"server":"//;s/"//' | sort -u | tr '\n' ',' | sed 's/,$//'
}

get_default_profile_id() {
    grep -o '"default_profile_id":"[^"]*"' "$PROFILES_FILE" | head -1 | sed 's/.*"default_profile_id":"//;s/"//'
}

get_profile_port() {
    local pid="$1" mode="$2"
    local key
    case "$mode" in
        full_vpn) key="port_full_vpn" ;;
        *) key="port_global_except_ru" ;;
    esac
    grep -o "\"id\":\"$pid\"[^}]*" "$PROFILES_FILE" | grep -o "\"$key\":[0-9]*" | head -1 | sed "s/\"$key\"://"
}

get_profile_field() {
    local pid="$1" field="$2"
    grep -o "\"id\":\"$pid\"[^}]*" "$PROFILES_FILE" | grep -o "\"$field\":\"[^\"]*\"" | head -1 | sed "s/\"$field\":\"//;s/\"//"
}

get_profile_ids() {
    grep -o '"id":"[^"]*"' "$PROFILES_FILE" | sed 's/"id":"//;s/"//'
}

# ===== Custom rules helpers =====

add_custom_rule() {
    local domain="$1" direction="$2"
    local current=$(grep -o "\"$direction\":\[[^]]*\]" "$CUSTOM_RULES_FILE" | sed "s/\"$direction\":\[//;s/\]$//")
    echo "$current" | grep -q "\"$domain\"" && return 0
    if [ -z "$current" ]; then new="\"$domain\""; else new="${current},\"$domain\""; fi
    sed -i "s|\"$direction\":\[[^]]*\]|\"$direction\":[$new]|" "$CUSTOM_RULES_FILE"
}

delete_custom_rule() {
    local domain="$1" direction="$2"
    sed -i "s|,\"$domain\"||g; s|\"$domain\",||g; s|\"$domain\"||g" "$CUSTOM_RULES_FILE"
}

build_custom_rules_file() {
    local mode="$1" route_out="$2" dns_out="$3"
    local rules_file="$CUSTOM_RULES_FILE"
    > "$route_out"; > "$dns_out"
    [ -f "$rules_file" ] || return 0

    local direct=$(grep -o '"direct":\[[^]]*\]' "$rules_file" | sed 's/"direct":\[//;s/\]$//' | tr -d ' ')
    local vpn=$(grep -o '"vpn":\[[^]]*\]' "$rules_file" | sed 's/"vpn":\[//;s/\]$//' | tr -d ' ')

    case "$mode" in
        global_except_ru)
            [ -n "$direct" ] && {
                echo "      {\"domain_suffix\":[$direct],\"outbound\":\"direct\"}," >> "$route_out"
                echo "      {\"domain_suffix\":[$direct],\"server\":\"dns-direct\"}," >> "$dns_out"
            }
            [ -n "$vpn" ] && {
                echo "      {\"domain_suffix\":[$vpn],\"outbound\":\"vless-out\"}," >> "$route_out"
                echo "      {\"domain_suffix\":[$vpn],\"server\":\"dns-remote\"}," >> "$dns_out"
            }
            ;;
        full_vpn)
            [ -n "$direct" ] && {
                echo "      ,{\"domain_suffix\":[$direct],\"outbound\":\"direct\"}" >> "$route_out"
                echo "      ,{\"domain_suffix\":[$direct],\"server\":\"dns-direct\"}" >> "$dns_out"
            }
            ;;
    esac
}

regenerate_all_configs() {
    get_profile_ids | while read pid; do
        local server=$(get_profile_field "$pid" "server")
        local server_port=$(grep -o "\"id\":\"$pid\"[^}]*" "$PROFILES_FILE" | grep -o '"server_port":[0-9]*' | head -1 | sed 's/"server_port"://')
        local uuid=$(get_profile_field "$pid" "uuid")
        local pbk=$(get_profile_field "$pid" "public_key")
        local sid=$(get_profile_field "$pid" "short_id")
        local sni=$(get_profile_field "$pid" "sni")
        local fp=$(get_profile_field "$pid" "fingerprint")
        local flow=$(get_profile_field "$pid" "flow")
        local security=$(get_profile_field "$pid" "security")
        local port_full=$(get_profile_port "$pid" "full_vpn")
        local port_global=$(get_profile_port "$pid" "global_except_ru")
        generate_configs "$pid" "$port_full" "$port_global" \
            "$server" "$server_port" "$uuid" "$pbk" "$sid" "$sni" "$fp" "$flow" "$security"
    done
    /etc/init.d/sing-box restart 2>/dev/null
}

# Build VPN_SERVERS exclusion string from all profiles
ALL_SERVERS=$(get_all_servers)
if [ -n "$ALL_SERVERS" ]; then
    VPN_EXCLUDE="10.0.0.0/8, 127.0.0.0/8, 192.168.0.0/16, $ALL_SERVERS"
else
    VPN_EXCLUDE="10.0.0.0/8, 127.0.0.0/8, 192.168.0.0/16"
fi

get_tproxy_port() {
    local mac="$1"
    local routing="$2"
    local profile_id
    profile_id=$(grep -o "\"$mac\":{[^}]*}" "$STATE_FILE" | grep -o '"profile_id":"[^"]*"' | cut -d'"' -f4)
    [ -z "$profile_id" ] && profile_id=$(get_default_profile_id)
    [ -z "$profile_id" ] && { echo "12345"; return; }
    local port
    port=$(get_profile_port "$profile_id" "$routing")
    [ -z "$port" ] && port="12345"
    echo "$port"
}

# Read POST data
if [ "$REQUEST_METHOD" = "POST" ]; then
    read -r POST_DATA
    QUERY_STRING="$POST_DATA"
fi

# Parse query string
action="" ; mac="" ; name="" ; preset="" ; vless_uri="" ; profile_id="" ; rule_domain="" ; rule_action=""
IFS='&' ; set -- $QUERY_STRING
for param; do
    key="${param%%=*}"
    val="${param#*=}"
    case "$key" in
        action) action="$val" ;;
        mac) mac="$(echo "$val" | sed 's/%3A/:/g; s/%3a/:/g')" ;;
        name) name="$(echo "$val" | sed 's/+/ /g; s/%20/ /g; s/%\([0-9A-Fa-f][0-9A-Fa-f]\)/\\x\1/g' | xargs -0 printf '%b' 2>/dev/null || echo "$val" | sed 's/+/ /g; s/%20/ /g')" ;;
        preset) preset="$val" ;;
        vless_uri) vless_uri="$(echo "$val" | sed 's/%3A/:/g; s/%3a/:/g; s/%40/@/g; s/%3F/?/g; s/%3f/?/g; s/%23/#/g; s/%26/\&/g; s/%3D/=/g; s/%3d/=/g; s/%2F/\//g; s/%2f/\//g; s/+/ /g')" ;;
        profile_id) profile_id="$val" ;;
        rule_domain) rule_domain="$(echo "$val" | sed 's/+/ /g; s/%2F/\//g; s/%2f/\//g' | tr -d ' ')" ;;
        rule_action) rule_action="$val" ;;
    esac
done
unset IFS

valid_mac() {
    echo "$1" | grep -qiE '^([0-9a-f]{2}:){5}[0-9a-f]{2}$'
}

# ===== vless:// URI parser =====

parse_vless_uri() {
    local raw="$1"
    local uri name_part query authority uuid hostport

    # Strip vless:// prefix
    uri="${raw#vless://}"

    # Extract fragment (name)
    case "$uri" in
        *"#"*) P_NAME="${uri##*#}"; uri="${uri%%#*}" ;;
        *) P_NAME="" ;;
    esac
    P_NAME=$(echo "$P_NAME" | sed 's/%20/ /g; s/+/ /g')

    # Extract query string
    case "$uri" in
        *"?"*) query="${uri##*\?}"; authority="${uri%%\?*}" ;;
        *) query=""; authority="$uri" ;;
    esac

    # Extract UUID, server, port
    P_UUID="${authority%%@*}"
    hostport="${authority##*@}"
    P_SERVER="${hostport%:*}"
    P_PORT="${hostport##*:}"

    # Parse query params
    P_PBK="" ; P_SID="" ; P_SNI="" ; P_FP="chrome" ; P_FLOW="" ; P_SECURITY="reality"
    local old_ifs="$IFS"
    IFS='&'
    for kv in $query; do
        local k="${kv%%=*}" v="${kv#*=}"
        case "$k" in
            pbk) P_PBK="$v" ;;
            sid) P_SID="$v" ;;
            sni) P_SNI="$v" ;;
            fp) P_FP="$v" ;;
            flow) P_FLOW="$v" ;;
            security) P_SECURITY="$v" ;;
        esac
    done
    IFS="$old_ifs"

    [ -z "$P_FP" ] && P_FP="chrome"
    [ -z "$P_NAME" ] && P_NAME="$P_SERVER"

    # Defaults depend on security type
    case "$P_SECURITY" in
        none)
            P_FLOW=""
            P_PBK="" ; P_SID="" ; P_SNI=""
            ;;
        *)
            P_SECURITY="reality"
            [ -z "$P_FLOW" ] && P_FLOW="xtls-rprx-vision"
            ;;
    esac

    # Validate
    [ -z "$P_UUID" ] && return 1
    [ -z "$P_SERVER" ] && return 1
    [ -z "$P_PORT" ] && return 1
    # Reality requires pbk and sid
    [ "$P_SECURITY" = "reality" ] && { [ -z "$P_PBK" ] && return 1; [ -z "$P_SID" ] && return 1; }
    [ "$P_PORT" -ge 1 ] 2>/dev/null && [ "$P_PORT" -le 65535 ] 2>/dev/null || return 1
    return 0
}

# ===== Generate sing-box configs from template =====

generate_configs() {
    local pid="$1" port_full="$2" port_global="$3"
    local server="$4" server_port="$5" uuid="$6"
    local pbk="$7" sid="$8" sni="$9"
    shift 9
    local fp="$1" flow="$2" security="$3"

    # Build security block (flow + tls) or empty for security=none
    local sec_file="/tmp/sb_sec_block_$$"
    if [ "$security" = "none" ]; then
        printf '' > "$sec_file"
    else
        cat > "$sec_file" << SECEOF
,
      "flow": "$flow",
      "tls": {
        "enabled": true,
        "server_name": "$sni",
        "utls": {
          "enabled": true,
          "fingerprint": "$fp"
        },
        "reality": {
          "enabled": true,
          "public_key": "$pbk",
          "short_id": "$sid"
        }
      }
SECEOF
    fi

    for mode in full_vpn global_except_ru; do
        local tpl="$TEMPLATES_DIR/config_${mode}.tpl.json"
        [ -f "$tpl" ] || continue
        local listen_port
        case "$mode" in
            full_vpn) listen_port="$port_full" ;;
            *) listen_port="$port_global" ;;
        esac

        local cr_route="/tmp/sb_custom_route_$$"
        local cr_dns="/tmp/sb_custom_dns_$$"
        build_custom_rules_file "$mode" "$cr_route" "$cr_dns"

        sed \
            -e "s|%%LISTEN_PORT%%|$listen_port|g" \
            -e "s|%%PROFILE_ID%%|$pid|g" \
            -e "s|%%VLESS_SERVER%%|$server|g" \
            -e "s|%%VLESS_PORT%%|$server_port|g" \
            -e "s|%%VLESS_UUID%%|$uuid|g" \
            "$tpl" | awk -v secfile="$sec_file" -v crroute="$cr_route" -v crdns="$cr_dns" '
            /%%VLESS_SECURITY_BLOCK%%/ {
                gsub(/%%VLESS_SECURITY_BLOCK%%/, "")
                printf "%s", $0
                while ((getline line < secfile) > 0) print line
                close(secfile)
                next
            }
            /%%CUSTOM_ROUTE_RULES%%/ {
                while ((getline line < crroute) > 0) print line
                close(crroute)
                next
            }
            /%%CUSTOM_DNS_RULES%%/ {
                while ((getline line < crdns) > 0) print line
                close(crdns)
                next
            }
            { print }
            ' > "/etc/sing-box/config_${mode}_${pid}.json"
        rm -f "$cr_route" "$cr_dns"
    done
    rm -f "$sec_file"
}

# ===== JSON helpers =====

get_vpn_state() {
    grep -o "\"$1\":{[^}]*}" "$STATE_FILE" | grep -o '"vpn":[^,}]*' | grep -o '[^:]*$' | tr -d ' '
}
get_zapret_state() {
    grep -o "\"$1\":{[^}]*}" "$STATE_FILE" | grep -o '"zapret":[^,}]*' | grep -o '[^:]*$' | tr -d ' '
}
get_preset_state() {
    grep -o "\"$1\":{[^}]*}" "$STATE_FILE" | grep -o '"routing":"[^"]*"' | cut -d'"' -f4
}
get_device_profile() {
    grep -o "\"$1\":{[^}]*}" "$STATE_FILE" | grep -o '"profile_id":"[^"]*"' | cut -d'"' -f4
}
get_device_name() {
    grep -o "\"$1\":\"[^\"]*\"" "$NAMES_FILE" | head -1 | sed 's/.*:"//; s/"$//'
}
set_device_name() {
    local m="$1" n="$2"
    local tmp=$(sed "s/\"$m\":\"[^\"]*\",\?//g; s/,}/}/g; s/{,/{/g" "$NAMES_FILE" | tr -d '\n' | sed 's/[[:space:]]//g')
    [ "$tmp" = "{}" ] && tmp=""
    if [ -z "$tmp" ] || [ "$tmp" = "{}" ]; then
        echo "{\"$m\":\"$n\"}" > "$NAMES_FILE"
    else
        echo "${tmp%\}},\"$m\":\"$n\"}" > "$NAMES_FILE"
    fi
}
set_state() {
    local m="$1" vpn="$2" zapret="$3" routing="$4" pid="$5"
    [ -z "$routing" ] && routing="global_except_ru"
    [ -z "$pid" ] && pid=$(get_default_profile_id)
    local tmp=$(sed "s/\"$m\":{[^}]*},\?//g; s/,}/}/g; s/{,/{/g" "$STATE_FILE" | tr -d '\n' | sed 's/[[:space:]]//g')
    [ "$tmp" = "{}" ] && tmp=""
    if [ -z "$tmp" ] || [ "$tmp" = "{}" ]; then
        echo "{\"$m\":{\"vpn\":$vpn,\"zapret\":$zapret,\"routing\":\"$routing\",\"profile_id\":\"$pid\"}}" > "$STATE_FILE"
    else
        echo "${tmp%\}},\"$m\":{\"vpn\":$vpn,\"zapret\":$zapret,\"routing\":\"$routing\",\"profile_id\":\"$pid\"}}" > "$STATE_FILE"
    fi
}

# ===== NFT RULES =====

remove_bypass() {
    local m="$1"
    nft -a list chain ip proxy_tproxy prerouting 2>/dev/null | \
        grep "ether saddr $m" | grep -v "tproxy" | grep "accept" | \
        grep -oE 'handle [0-9]+' | awk '{print $2}' | while read handle; do
            nft delete rule ip proxy_tproxy prerouting handle "$handle" 2>/dev/null
        done
}

add_bypass() {
    local m="$1"
    nft list chain ip proxy_tproxy prerouting 2>/dev/null | grep "ether saddr $m" | grep -v "tproxy" | grep -q "accept" && return 0
    nft insert rule ip proxy_tproxy prerouting \
        iifname "$LAN_IFACE" ether saddr "$m" accept 2>/dev/null
}

apply_vpn_on() {
    local m="$1"
    local port="$2"
    remove_bypass "$m"
    nft list chain ip proxy_tproxy prerouting 2>/dev/null | grep "ether saddr $m" | grep -q "tproxy" && return 0
    nft insert rule ip proxy_tproxy prerouting \
        iifname "$LAN_IFACE" ether saddr "$m" \
        ip daddr != "{ $VPN_EXCLUDE }" \
        meta l4proto udp tproxy to :$port meta mark set 0x1 accept 2>/dev/null
    nft insert rule ip proxy_tproxy prerouting \
        iifname "$LAN_IFACE" ether saddr "$m" \
        ip daddr != "{ $VPN_EXCLUDE }" \
        meta l4proto tcp tproxy to :$port meta mark set 0x1 accept 2>/dev/null
}

apply_vpn_off() {
    local m="$1"
    nft -a list chain ip proxy_tproxy prerouting 2>/dev/null | \
        grep "ether saddr $m" | grep "tproxy" | \
        grep -oE 'handle [0-9]+' | awk '{print $2}' | while read handle; do
            nft delete rule ip proxy_tproxy prerouting handle "$handle" 2>/dev/null
        done
    add_bypass "$m"
}

apply_zapret_off() {
    local m="$1"
    nft -a list chain inet proxy_route forward_zapret 2>/dev/null | grep "ether saddr $m" | grep "accept" | \
        awk '{print $NF}' | while read handle; do
            nft delete rule inet proxy_route forward_zapret handle "$handle" 2>/dev/null
        done
}

apply_zapret_on() {
    local m="$1"
    nft list chain inet proxy_route forward_zapret 2>/dev/null | grep "ether saddr $m" | grep -q "accept" && return 0
    nft insert rule inet proxy_route forward_zapret ether saddr "$m" accept 2>/dev/null
}

# Rebuild catch-all rule with current default profile
rebuild_catchall() {
    # Remove old catch-all rules (those without "ether saddr")
    nft -a list chain ip proxy_tproxy prerouting 2>/dev/null | \
        grep "tproxy" | grep -v "ether saddr" | \
        grep -oE 'handle [0-9]+' | awk '{print $2}' | while read handle; do
            nft delete rule ip proxy_tproxy prerouting handle "$handle" 2>/dev/null
        done
    # Remove old catch-all return rule for zapret
    nft -a list chain inet proxy_route forward_zapret 2>/dev/null | \
        grep "iifname" | grep "return" | grep -v "ether saddr" | \
        grep -oE 'handle [0-9]+' | awk '{print $2}' | while read handle; do
            nft delete rule inet proxy_route forward_zapret handle "$handle" 2>/dev/null
        done

    local def_pid=$(get_default_profile_id)
    local port=$(get_profile_port "$def_pid" "global_except_ru")
    [ -z "$port" ] && port="12346"

    # Re-read ALL_SERVERS in case profiles changed
    local all_srv=$(get_all_servers)
    local excl="10.0.0.0/8, 127.0.0.0/8, 192.168.0.0/16"
    [ -n "$all_srv" ] && excl="$excl, $all_srv"

    nft add rule ip proxy_tproxy prerouting \
        iifname "$LAN_IFACE" \
        ip daddr != "{ $excl }" \
        meta l4proto tcp tproxy to :$port meta mark set 0x1 accept 2>/dev/null
    nft add rule ip proxy_tproxy prerouting \
        iifname "$LAN_IFACE" \
        ip daddr != "{ $excl }" \
        meta l4proto udp tproxy to :$port meta mark set 0x1 accept 2>/dev/null

    nft add rule inet proxy_route forward_zapret iifname "$LAN_IFACE" return 2>/dev/null
}

# Auto-update default profile when no devices remain on current default
auto_update_default() {
    local new_pid="$1"
    local cur_default=$(get_default_profile_id)
    [ "$new_pid" = "$cur_default" ] && return 0
    # If any device still uses the current default, keep it
    grep -q "\"profile_id\":\"$cur_default\"[,\"}]" "$STATE_FILE" && return 0
    # No devices on old default — switch default and rebuild catch-all
    sed -i "s/\"default_profile_id\":\"[^\"]*\"/\"default_profile_id\":\"$new_pid\"/" "$PROFILES_FILE"
    rebuild_catchall
}

# ===== Kill switch =====

apply_killswitch() {
    local lan="$LAN_IFACE"
    # Remove old killswitch rule
    nft -a list chain ip proxy_tproxy prerouting 2>/dev/null | \
        grep 'comment "killswitch"' | grep -oE 'handle [0-9]+' | \
        awk '{print $2}' | while read h; do
            nft delete rule ip proxy_tproxy prerouting handle "$h" 2>/dev/null
        done
    # Add killswitch drop rule at the END of chain
    nft add rule ip proxy_tproxy prerouting \
        iifname "$lan" \
        ip daddr != "{ 10.0.0.0/8, 127.0.0.0/8, 192.168.0.0/16 }" \
        drop comment '"killswitch"' 2>/dev/null
    echo "1" > /etc/vpn_killswitch
}

remove_killswitch() {
    nft -a list chain ip proxy_tproxy prerouting 2>/dev/null | \
        grep 'comment "killswitch"' | grep -oE 'handle [0-9]+' | \
        awk '{print $2}' | while read h; do
            nft delete rule ip proxy_tproxy prerouting handle "$h" 2>/dev/null
        done
    echo "0" > /etc/vpn_killswitch
}

# ===== Profile CRUD actions =====

do_add_profile() {
    local uri="$1"
    parse_vless_uri "$uri" || {
        echo "Status: 302 Found"
        echo "Location: /cgi-bin/vpn?err=invalid_uri"
        echo ""
        exit 0
    }

    # Check max profiles
    local count=$(grep -o '"id":"' "$PROFILES_FILE" | wc -l | tr -d ' ')
    [ "$count" -ge 4 ] && {
        echo "Status: 302 Found"
        echo "Location: /cgi-bin/vpn?err=max_profiles"
        echo ""
        exit 0
    }

    # Read next_port and next_id
    local next_port=$(grep -o '"next_port":[0-9]*' "$PROFILES_FILE" | head -1 | sed 's/"next_port"://')
    local next_id=$(grep -o '"next_id":[0-9]*' "$PROFILES_FILE" | head -1 | sed 's/"next_id"://')
    [ -z "$next_port" ] && next_port=12345
    [ -z "$next_id" ] && next_id=1

    local pid="p${next_id}"
    local port_full="$next_port"
    local port_global=$((next_port + 1))
    local new_next_port=$((next_port + 2))
    local new_next_id=$((next_id + 1))

    # Build new profile JSON entry
    local entry="{\"id\":\"$pid\",\"name\":\"$P_NAME\",\"server\":\"$P_SERVER\",\"server_port\":$P_PORT,\"uuid\":\"$P_UUID\",\"security\":\"$P_SECURITY\",\"public_key\":\"$P_PBK\",\"short_id\":\"$P_SID\",\"sni\":\"$P_SNI\",\"fingerprint\":\"$P_FP\",\"flow\":\"$P_FLOW\",\"port_full_vpn\":$port_full,\"port_global_except_ru\":$port_global}"

    # Insert into profiles array
    local old_profiles=$(grep -o '"profiles":\[[^]]*\]' "$PROFILES_FILE" | sed 's/"profiles":\[//;s/\]$//')
    local new_profiles
    if [ -z "$old_profiles" ]; then
        new_profiles="$entry"
    else
        new_profiles="${old_profiles},${entry}"
    fi

    # Set default if first profile
    local def_pid=$(get_default_profile_id)
    [ -z "$def_pid" ] && def_pid="$pid"

    echo "{\"profiles\":[$new_profiles],\"default_profile_id\":\"$def_pid\",\"next_port\":$new_next_port,\"next_id\":$new_next_id}" > "$PROFILES_FILE"

    # Generate sing-box configs
    generate_configs "$pid" "$port_full" "$port_global" \
        "$P_SERVER" "$P_PORT" "$P_UUID" "$P_PBK" "$P_SID" "$P_SNI" "$P_FP" "$P_FLOW" "$P_SECURITY"

    # Start new sing-box instances
    /etc/init.d/sing-box restart 2>/dev/null

    # Rebuild catch-all with updated server exclusion list
    rebuild_catchall
}

do_delete_profile() {
    local pid="$1"
    local def_pid=$(get_default_profile_id)

    # Cannot delete last profile
    local count=$(grep -o '"id":"' "$PROFILES_FILE" | wc -l | tr -d ' ')
    [ "$count" -le 1 ] && {
        echo "Status: 302 Found"
        echo "Location: /cgi-bin/vpn?err=last_profile"
        echo ""
        exit 0
    }

    # Remove configs
    rm -f "/etc/sing-box/config_full_vpn_${pid}.json"
    rm -f "/etc/sing-box/config_global_except_ru_${pid}.json"
    rm -f "/etc/sing-box/cache-full-${pid}.db"
    rm -f "/etc/sing-box/cache-global-${pid}.db"

    # Remove profile from JSON — rebuild without this profile
    local new_profiles=""
    get_profile_ids > /tmp/vpn_cgi_pids_$$
    while read id; do
        [ "$id" = "$pid" ] && continue
        local entry=$(grep -o "{\"id\":\"$id\"[^}]*}" "$PROFILES_FILE")
        if [ -z "$new_profiles" ]; then
            new_profiles="$entry"
        else
            new_profiles="${new_profiles},${entry}"
        fi
    done < /tmp/vpn_cgi_pids_$$
    rm -f /tmp/vpn_cgi_pids_$$

    local next_port=$(grep -o '"next_port":[0-9]*' "$PROFILES_FILE" | head -1 | sed 's/"next_port"://')
    local next_id=$(grep -o '"next_id":[0-9]*' "$PROFILES_FILE" | head -1 | sed 's/"next_id"://')

    # If deleted profile was default, pick first remaining
    local new_def="$def_pid"
    if [ "$def_pid" = "$pid" ]; then
        new_def=$(echo "$new_profiles" | grep -o '"id":"[^"]*"' | head -1 | sed 's/"id":"//;s/"//')
    fi

    echo "{\"profiles\":[$new_profiles],\"default_profile_id\":\"$new_def\",\"next_port\":$next_port,\"next_id\":$next_id}" > "$PROFILES_FILE"

    # Reassign devices on deleted profile to default
    grep -oE '"[0-9a-f:]{17}":\{[^}]*\}' "$STATE_FILE" | while IFS= read -r entry; do
        local m=$(echo "$entry" | grep -oE '[0-9a-f:]{17}')
        local p=$(echo "$entry" | grep -o '"profile_id":"[^"]*"' | cut -d'"' -f4)
        if [ "$p" = "$pid" ]; then
            local vpn_val=$(echo "$entry" | grep -o '"vpn":[a-z]*' | cut -d: -f2)
            local zapret_val=$(echo "$entry" | grep -o '"zapret":[a-z]*' | cut -d: -f2)
            local routing=$(echo "$entry" | grep -o '"routing":"[^"]*"' | cut -d'"' -f4)
            set_state "$m" "$vpn_val" "$zapret_val" "$routing" "$new_def"
            # Re-apply nft rules with new port
            if [ "$vpn_val" = "true" ]; then
                apply_vpn_off "$m"
                remove_bypass "$m"
                local port=$(get_profile_port "$new_def" "$routing")
                apply_vpn_on "$m" "$port"
            fi
        fi
    done

    # Restart sing-box and rebuild catch-all
    /etc/init.d/sing-box restart 2>/dev/null
    rebuild_catchall
}

do_set_default_profile() {
    local pid="$1"
    local contents=$(cat "$PROFILES_FILE")
    echo "$contents" | sed "s/\"default_profile_id\":\"[^\"]*\"/\"default_profile_id\":\"$pid\"/" > "$PROFILES_FILE"
    rebuild_catchall
}

# ===== Handle actions =====

case "$action" in
    killswitch_on)
        apply_killswitch
        echo "Status: 302 Found"
        echo "Location: /cgi-bin/vpn"
        echo ""
        exit 0
        ;;
    killswitch_off)
        remove_killswitch
        echo "Status: 302 Found"
        echo "Location: /cgi-bin/vpn"
        echo ""
        exit 0
        ;;
    add_rule)
        if [ -n "$rule_domain" ] && echo "$rule_action" | grep -qE '^(direct|vpn)$'; then
            # Validate domain: letters, digits, dots, hyphens only
            if echo "$rule_domain" | grep -qE '^[a-zA-Z0-9]([a-zA-Z0-9.-]*[a-zA-Z0-9])?$'; then
                add_custom_rule "$rule_domain" "$rule_action"
                regenerate_all_configs
            fi
        fi
        echo "Status: 302 Found"
        echo "Location: /cgi-bin/vpn"
        echo ""
        exit 0
        ;;
    delete_rule)
        if [ -n "$rule_domain" ] && echo "$rule_action" | grep -qE '^(direct|vpn)$'; then
            delete_custom_rule "$rule_domain" "$rule_action"
            regenerate_all_configs
        fi
        echo "Status: 302 Found"
        echo "Location: /cgi-bin/vpn"
        echo ""
        exit 0
        ;;
    add_profile)
        do_add_profile "$vless_uri"
        echo "Status: 302 Found"
        echo "Location: /cgi-bin/vpn"
        echo ""
        exit 0
        ;;
    delete_profile)
        do_delete_profile "$profile_id"
        echo "Status: 302 Found"
        echo "Location: /cgi-bin/vpn"
        echo ""
        exit 0
        ;;
    set_default_profile)
        do_set_default_profile "$profile_id"
        echo "Status: 302 Found"
        echo "Location: /cgi-bin/vpn"
        echo ""
        exit 0
        ;;
    rename_profile)
        if [ -n "$profile_id" ] && [ -n "$name" ]; then
            sed -i "s/\"id\":\"$profile_id\",\"name\":\"[^\"]*\"/\"id\":\"$profile_id\",\"name\":\"$name\"/" "$PROFILES_FILE"
        fi
        echo "Status: 302 Found"
        echo "Location: /cgi-bin/vpn"
        echo ""
        exit 0
        ;;
esac

if valid_mac "$mac" && [ -n "$action" ]; then
    cur_vpn=$(get_vpn_state "$mac")
    cur_zapret=$(get_zapret_state "$mac")
    cur_preset=$(get_preset_state "$mac")
    cur_profile=$(get_device_profile "$mac")
    [ -z "$cur_vpn" ] && cur_vpn="true"
    [ -z "$cur_zapret" ] && cur_zapret="false"
    [ -z "$cur_preset" ] && cur_preset="global_except_ru"
    [ -z "$cur_profile" ] && cur_profile=$(get_default_profile_id)

    case "$action" in
        vpn_on)
            port=$(get_tproxy_port "$mac" "$cur_preset")
            apply_vpn_on "$mac" "$port"
            set_state "$mac" "true" "$cur_zapret" "$cur_preset" "$cur_profile"
            ;;
        vpn_off)
            apply_vpn_off "$mac"
            set_state "$mac" "false" "$cur_zapret" "$cur_preset" "$cur_profile"
            ;;
        zapret_on)
            apply_zapret_on "$mac"
            set_state "$mac" "$cur_vpn" "true" "$cur_preset" "$cur_profile"
            ;;
        zapret_off)
            apply_zapret_off "$mac"
            set_state "$mac" "$cur_vpn" "false" "$cur_preset" "$cur_profile"
            ;;
        set_name)
            set_device_name "$mac" "$name"
            ;;
        set_routing)
            if echo "$preset" | grep -qE '^(full_vpn|global_except_ru)$'; then
                new_port=$(get_tproxy_port "$mac" "$preset")
                if nft list chain ip proxy_tproxy prerouting 2>/dev/null | grep "ether saddr $mac" | grep -q "tproxy"; then
                    apply_vpn_off "$mac"
                    remove_bypass "$mac"
                    apply_vpn_on "$mac" "$new_port"
                fi
                set_state "$mac" "$cur_vpn" "$cur_zapret" "$preset" "$cur_profile"
            fi
            ;;
        set_profile)
            if [ -n "$profile_id" ]; then
                new_port=$(get_profile_port "$profile_id" "$cur_preset")
                if nft list chain ip proxy_tproxy prerouting 2>/dev/null | grep "ether saddr $mac" | grep -q "tproxy"; then
                    apply_vpn_off "$mac"
                    remove_bypass "$mac"
                    apply_vpn_on "$mac" "$new_port"
                fi
                set_state "$mac" "$cur_vpn" "$cur_zapret" "$cur_preset" "$profile_id"
                auto_update_default "$profile_id"
            fi
            ;;
        add_device)
            [ -n "$name" ] && set_device_name "$mac" "$name"
            def_pid=$(get_default_profile_id)
            port=$(get_tproxy_port "$mac" "global_except_ru")
            apply_vpn_on "$mac" "$port"
            apply_zapret_off "$mac"
            set_state "$mac" "true" "false" "global_except_ru" "$def_pid"
            ;;
        delete_device)
            apply_vpn_off "$mac"
            remove_bypass "$mac"
            apply_zapret_off "$mac"
            sed -i "s/\"$mac\":{[^}]*},\?//g; s/,}/}/g; s/{,/{/g" "$STATE_FILE"
            sed -i "s/\"$mac\":\"[^\"]*\",\?//g; s/,}/}/g; s/{,/{/g" "$NAMES_FILE"
            ;;
    esac

    echo "Status: 302 Found"
    echo "Location: /cgi-bin/vpn"
    echo ""
    exit 0
fi

# ===== Collect devices =====
get_devices() {
    [ -f /tmp/dhcp.leases ] && awk '{print tolower($2), $3, ($4 == "*" ? "" : $4)}' /tmp/dhcp.leases
    ip neigh show 2>/dev/null | awk '/lladdr/ && $1 !~ /:/ {print tolower($5), $1, ""}'
    grep -oE '"[0-9a-f:]{17}"' "$STATE_FILE" | tr -d '"' | while read m; do
        echo "$m - -"
    done
}

devices=$(get_devices | awk '!seen[$1]++ {print}')

# Detect actual nft state
nft_rules=$(nft list chain ip proxy_tproxy prerouting 2>/dev/null)
nft_vpn_macs=$(echo "$nft_rules" | grep "tproxy" | grep -oE 'ether saddr [0-9a-f:]+' | awk '{print $3}' | sort -u)
nft_bypass_macs=$(echo "$nft_rules" | grep -v "tproxy" | grep "ether saddr" | grep "accept" | grep -oE 'ether saddr [0-9a-f:]+' | awk '{print $3}' | sort -u)
nft_zapret_on=$(nft list chain inet proxy_route forward_zapret 2>/dev/null | grep "accept" | grep -oE 'ether saddr [0-9a-f:]+' | awk '{print $3}' | sort -u)
has_catchall=$(echo "$nft_rules" | grep "tproxy" | grep -v "ether saddr" | grep -c "$LAN_IFACE")

# Parse error param
err=""
case "$QUERY_STRING" in
    *err=invalid_uri*) err="Invalid vless:// URI" ;;
    *err=max_profiles*) err="Maximum 4 profiles reached" ;;
    *err=last_profile*) err="Cannot delete the last profile" ;;
    *err=invalid_domain*) err="Invalid domain name" ;;
esac

# --- HTML output ---
echo "Content-Type: text/html; charset=utf-8"
echo ""
cat <<'HTMLHEAD'
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>VPN / Zapret Control</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,system-ui,sans-serif;background:#1a1a2e;color:#e0e0e0;padding:16px;max-width:800px;margin:0 auto}
h1{text-align:center;margin-bottom:20px;font-size:1.4em;color:#00d2ff}
.section{background:#16213e;border-radius:12px;padding:14px;margin-bottom:12px}
.section h2{font-size:1em;color:#00d2ff;margin-bottom:10px}
.device{background:#16213e;border-radius:12px;padding:14px;margin-bottom:12px;display:flex;flex-wrap:wrap;align-items:center;gap:10px}
.info{flex:1;min-width:150px}
.hostname{font-weight:600;font-size:1.05em;color:#fff;display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.edit-btn{background:none;border:none;color:#00d2ff;cursor:pointer;font-size:.75em;padding:2px 6px}
.edit-btn:hover{text-decoration:underline}
.del-btn{background:none;border:none;color:#ff4444;cursor:pointer;font-size:.7em;padding:2px 6px}
.del-btn:hover{text-decoration:underline}
.name-input{background:#0f3460;border:1px solid #00d2ff;color:#fff;border-radius:6px;padding:4px 8px;font-size:.9em;width:140px}
.name-save{background:#00d2ff;color:#000;border:none;border-radius:6px;padding:4px 10px;cursor:pointer;font-size:.8em;font-weight:600}
.ip{color:#888;font-size:.85em}
.mac{color:#666;font-size:.75em;font-family:monospace}
.controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.btn{padding:8px 16px;border:none;border-radius:8px;font-size:.85em;font-weight:600;cursor:pointer;text-decoration:none;text-align:center;min-width:90px;transition:background .2s}
.btn-on{background:#00c853;color:#fff}
.btn-off{background:#444;color:#aaa}
.btn-default{background:#0f7c3f;color:#cfc;border:1px dashed #00c853}
.btn-on:hover{background:#00e676}
.btn-off:hover{background:#555}
.btn-default:hover{background:#0a9e4f}
.btn-sm{padding:6px 12px;font-size:.8em;min-width:auto}
.btn-danger{background:#c62828;color:#fff}
.btn-danger:hover{background:#e53935}
.btn-primary{background:#00d2ff;color:#000}
.btn-primary:hover{background:#33ddff}
.label{font-size:.7em;display:block;color:#888;margin-bottom:2px;text-transform:uppercase;letter-spacing:1px}
.toggle{display:flex;flex-direction:column;align-items:center}
.preset-select{background:#0f3460;color:#e0e0e0;border:1px solid #333;border-radius:8px;padding:6px 8px;font-size:.8em;cursor:pointer}
.preset-select:focus{border-color:#00d2ff;outline:none}
.add-section{background:#16213e;border-radius:12px;padding:16px;margin-bottom:12px}
.add-section h2{font-size:1em;color:#00d2ff;margin-bottom:10px}
.add-form{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.add-input{background:#0f3460;border:1px solid #333;color:#fff;border-radius:8px;padding:8px 12px;font-size:.9em}
.add-input:focus{border-color:#00d2ff;outline:none}
.add-btn{background:#00d2ff;color:#000;border:none;border-radius:8px;padding:8px 16px;font-weight:600;cursor:pointer;font-size:.9em}
.add-btn:hover{background:#33ddff}
.profile-card{background:#0f3460;border-radius:8px;padding:10px 14px;margin-bottom:8px;display:flex;flex-wrap:wrap;align-items:center;gap:10px}
.profile-info{flex:1;min-width:150px}
.profile-name{font-weight:600;color:#fff}
.profile-server{color:#888;font-size:.85em;font-family:monospace}
.profile-ports{color:#666;font-size:.75em}
.profile-actions{display:flex;gap:6px;flex-wrap:wrap}
.status-up{color:#00c853;font-weight:600}
.status-down{color:#ff4444;font-weight:600}
.status-check{color:#888}
.badge-default{background:#0f7c3f;color:#cfc;border-radius:4px;padding:2px 6px;font-size:.7em;font-weight:600;margin-left:6px}
.error-msg{background:#c62828;color:#fff;border-radius:8px;padding:10px 14px;margin-bottom:12px;text-align:center}
.footer{text-align:center;margin-top:20px;color:#555;font-size:.8em}
</style>
<script>
function editName(mac, current) {
    var el = document.getElementById('name-' + mac.replace(/:/g, '-'));
    el.innerHTML = '<form method="POST" action="/cgi-bin/vpn" style="display:flex;gap:4px;align-items:center;flex-wrap:wrap">' +
        '<input type="hidden" name="action" value="set_name">' +
        '<input type="hidden" name="mac" value="' + mac + '">' +
        '<input class="name-input" type="text" name="name" value="' + current + '" autofocus>' +
        '<button class="name-save" type="submit">OK</button></form>';
}
function confirmDelete(mac, name) {
    if (confirm('Remove ' + name + ' (' + mac + ')?')) {
        window.location = '?action=delete_device&mac=' + mac.replace(/:/g, '%3A');
    }
}
function editProfileName(pid, current) {
    var el = document.getElementById('pname-' + pid);
    el.innerHTML = '<form method="POST" action="/cgi-bin/vpn" style="display:inline-flex;gap:4px;align-items:center">' +
        '<input type="hidden" name="action" value="rename_profile">' +
        '<input type="hidden" name="profile_id" value="' + pid + '">' +
        '<input class="name-input" type="text" name="name" value="' + current + '" autofocus>' +
        '<button class="name-save" type="submit">OK</button></form>';
}
function confirmDeleteProfile(pid, name) {
    if (confirm('Delete profile "' + name + '"? Devices will be reassigned to default.')) {
        window.location = '?action=delete_profile&profile_id=' + pid;
    }
}
function changePreset(mac, preset) {
    var form = document.createElement('form');
    form.method = 'POST'; form.action = '/cgi-bin/vpn';
    var fields = {action: 'set_routing', mac: mac, preset: preset};
    for (var k in fields) {
        var inp = document.createElement('input');
        inp.type = 'hidden'; inp.name = k; inp.value = fields[k];
        form.appendChild(inp);
    }
    document.body.appendChild(form); form.submit();
}
function changeProfile(mac, pid) {
    var form = document.createElement('form');
    form.method = 'POST'; form.action = '/cgi-bin/vpn';
    var fields = {action: 'set_profile', mac: mac, profile_id: pid};
    for (var k in fields) {
        var inp = document.createElement('input');
        inp.type = 'hidden'; inp.name = k; inp.value = fields[k];
        form.appendChild(inp);
    }
    document.body.appendChild(form); form.submit();
}
</script>
</head>
<body>
<h1>VPN / Zapret Control Panel</h1>
HTMLHEAD

# ===== Error message =====
if [ -n "$err" ]; then
    echo "<div class=\"error-msg\">$err</div>"
fi

# ===== Profiles section =====
cat <<'PROFILEHEAD'
<div class="section">
<h2>VPN Profiles</h2>
<form class="add-form" method="POST" action="/cgi-bin/vpn" style="margin-bottom:12px">
<input type="hidden" name="action" value="add_profile">
<input class="add-input" type="text" name="vless_uri" placeholder="vless://uuid@server:port?...#Name" required style="flex:1;min-width:250px">
<button class="add-btn" type="submit">Add Profile</button>
</form>
PROFILEHEAD

default_pid=$(get_default_profile_id)

get_profile_ids | while read pid; do
    p_name=$(get_profile_field "$pid" "name")
    p_server=$(get_profile_field "$pid" "server")
    p_port_full=$(get_profile_port "$pid" "full_vpn")
    p_port_global=$(get_profile_port "$pid" "global_except_ru")
    p_server_port=$(grep -o "\"id\":\"$pid\"[^}]*" "$PROFILES_FILE" | grep -o '"server_port":[0-9]*' | head -1 | sed 's/"server_port"://')
    p_security=$(get_profile_field "$pid" "security")
    [ -z "$p_security" ] && p_security="reality"

    # Check server status via sing-box process
    status_class="status-check"
    status_text="..."
    if pgrep -f "config_full_vpn_${pid}.json" >/dev/null 2>&1; then
        status_class="status-up"
        status_text="UP"
    else
        status_class="status-down"
        status_text="DOWN"
    fi

    default_badge=""
    [ "$pid" = "$default_pid" ] && default_badge='<span class="badge-default">DEFAULT</span>'

    cat <<EOF
<div class="profile-card">
  <div class="profile-info">
    <div class="profile-name" id="pname-${pid}"><span>${p_name}</span><span class="edit-btn" onclick="editProfileName('${pid}','${p_name}')">edit</span>${default_badge} <span class="${status_class}">${status_text}</span></div>
    <div class="profile-server">${p_server}:${p_server_port} [${p_security}]</div>
    <div class="profile-ports">Ports: full=${p_port_full} global-ru=${p_port_global}</div>
  </div>
  <div class="profile-actions">
EOF
    if [ "$pid" != "$default_pid" ]; then
        echo "    <a class=\"btn btn-sm btn-primary\" href=\"?action=set_default_profile&profile_id=${pid}\">Set Default</a>"
        echo "    <span class=\"btn btn-sm btn-danger\" onclick=\"confirmDeleteProfile('${pid}','${p_name}')\">Delete</span>"
    fi
    echo "  </div>"
    echo "</div>"
done

echo "</div>"

# ===== Kill Switch section =====
killswitch_state=$(cat /etc/vpn_killswitch 2>/dev/null || echo "0")
if [ "$killswitch_state" = "1" ]; then
    ks_class="btn-on"; ks_text="ON"; ks_action="killswitch_off"
else
    ks_class="btn-off"; ks_text="OFF"; ks_action="killswitch_on"
fi
cat <<EOF
<div class="section">
  <div style="display:flex;align-items:center;justify-content:space-between">
    <div>
      <h2>Kill Switch</h2>
      <div style="color:#888;font-size:.8em">Drop all traffic if VPN is down</div>
    </div>
    <a class="btn ${ks_class}" href="?action=${ks_action}">${ks_text}</a>
  </div>
</div>
EOF

# ===== Custom Routes section =====
cat <<'CUSTOMHEAD'
<div class="section">
<h2>Custom Routes</h2>
CUSTOMHEAD

# Show existing rules
direct_domains=$(grep -o '"direct":\[[^]]*\]' "$CUSTOM_RULES_FILE" 2>/dev/null | sed 's/"direct":\[//;s/\]$//' | tr -d ' ')
vpn_domains=$(grep -o '"vpn":\[[^]]*\]' "$CUSTOM_RULES_FILE" 2>/dev/null | sed 's/"vpn":\[//;s/\]$//' | tr -d ' ')

has_rules=""
echo "$direct_domains" | tr ',' '\n' | tr -d '"' | while read d; do
    [ -z "$d" ] && continue
    enc_d=$(echo "$d" | sed 's/ /%20/g')
    echo "<div class=\"profile-card\"><div class=\"profile-info\"><span class=\"profile-name\">${d}</span> <span style=\"color:#00c853;font-size:.8em\">DIRECT</span></div><div class=\"profile-actions\"><a class=\"btn btn-sm btn-danger\" href=\"?action=delete_rule&rule_domain=${enc_d}&rule_action=direct\">Delete</a></div></div>"
done

echo "$vpn_domains" | tr ',' '\n' | tr -d '"' | while read d; do
    [ -z "$d" ] && continue
    enc_d=$(echo "$d" | sed 's/ /%20/g')
    echo "<div class=\"profile-card\"><div class=\"profile-info\"><span class=\"profile-name\">${d}</span> <span style=\"color:#00d2ff;font-size:.8em\">VPN</span></div><div class=\"profile-actions\"><a class=\"btn btn-sm btn-danger\" href=\"?action=delete_rule&rule_domain=${enc_d}&rule_action=vpn\">Delete</a></div></div>"
done

cat <<'CUSTOMFORM'
<form class="add-form" method="POST" action="/cgi-bin/vpn" style="margin-top:10px">
<input type="hidden" name="action" value="add_rule">
<input class="add-input" type="text" name="rule_domain" placeholder="example.com" required style="flex:1;min-width:180px">
<select class="preset-select" name="rule_action">
<option value="direct">Direct (bypass VPN)</option>
<option value="vpn">VPN (force through VPN)</option>
</select>
<button class="add-btn" type="submit">Add Rule</button>
</form>
<div style="color:#666;font-size:.75em;margin-top:6px">* covers the domain and all its subdomains</div>
</div>
CUSTOMFORM

# ===== Add device section =====
cat <<'ADDDEVICE'
<div class="add-section">
<h2>+ Add device (default: VPN ON, Global -RU)</h2>
<form class="add-form" method="POST" action="/cgi-bin/vpn">
<input type="hidden" name="action" value="add_device">
<input class="add-input" type="text" name="mac" placeholder="MAC (aa:bb:cc:dd:ee:ff)" pattern="[0-9a-fA-F]{2}(:[0-9a-fA-F]{2}){5}" required style="width:220px">
<input class="add-input" type="text" name="name" placeholder="Name" style="width:150px">
<button class="add-btn" type="submit">Add</button>
</form>
</div>
ADDDEVICE

# ===== Build profile list for select dropdown =====
get_profile_ids | while read pid; do
    p_name=$(get_profile_field "$pid" "name")
    echo "$pid|$p_name"
done > /tmp/vpn_cgi_profile_opts_$$

# ===== Device list =====
echo "$devices" | while read mac ip dhcp_name; do
    [ -z "$mac" ] && continue
    case "$ip" in "$ROUTER_IP") continue ;; esac
    case "$ip" in *:*) continue ;; esac

    custom_name=$(get_device_name "$mac")
    if [ -n "$custom_name" ]; then
        display_name="$custom_name"
    elif [ -n "$dhcp_name" ] && [ "$dhcp_name" != "-" ]; then
        display_name="$dhcp_name"
    elif [ -n "$ip" ] && [ "$ip" != "-" ]; then
        display_name="$ip"
    else
        display_name="$mac"
    fi

    # Detect real state from nft
    has_tproxy=""
    has_bypass=""
    echo "$nft_vpn_macs" | grep -qi "$mac" && has_tproxy="yes"
    echo "$nft_bypass_macs" | grep -qi "$mac" && has_bypass="yes"

    # Determine VPN display state
    is_default=""
    if [ -n "$has_tproxy" ]; then
        vpn_st="true"
    elif [ -n "$has_bypass" ]; then
        vpn_st="false"
    elif [ "$has_catchall" -gt 0 ] 2>/dev/null; then
        vpn_st="true"
        is_default="yes"
    else
        vpn_st="false"
    fi

    zapret_st="false"
    echo "$nft_zapret_on" | grep -qi "$mac" && zapret_st="true"

    dev_preset=$(get_preset_state "$mac")
    [ -z "$dev_preset" ] && dev_preset="global_except_ru"

    dev_profile=$(get_device_profile "$mac")
    [ -z "$dev_profile" ] && dev_profile="$default_pid"

    if [ "$vpn_st" = "true" ]; then
        if [ -n "$is_default" ]; then
            vpn_class="btn-default"; vpn_text="DEFAULT"; vpn_action="vpn_off"
        else
            vpn_class="btn-on"; vpn_text="VPN ON"; vpn_action="vpn_off"
        fi
    else
        vpn_class="btn-off"; vpn_text="VPN OFF"; vpn_action="vpn_on"
    fi

    if [ "$zapret_st" = "true" ]; then
        zap_class="btn-on"; zap_text="DPI ON"; zap_action="zapret_off"
    else
        zap_class="btn-off"; zap_text="DPI OFF"; zap_action="zapret_on"
    fi

    enc_mac=$(echo "$mac" | sed 's/:/%3A/g')
    safe_mac=$(echo "$mac" | sed 's/:/-/g')

    if [ "$dev_preset" = "global_except_ru" ]; then
        sel_full="" ; sel_global=" selected"
    else
        sel_full=" selected" ; sel_global=""
    fi

    # Build profile select options
    profile_select=""
    while IFS='|' read pid pname; do
        [ -z "$pid" ] && continue
        sel=""
        [ "$pid" = "$dev_profile" ] && sel=" selected"
        profile_select="${profile_select}<option value=\"${pid}\"${sel}>${pname}</option>"
    done < /tmp/vpn_cgi_profile_opts_$$ 2>/dev/null

    # Fallback: re-read if temp file gone
    if [ -z "$profile_select" ]; then
        get_profile_ids | while read pid; do
            p_name=$(get_profile_field "$pid" "name")
            sel=""
            [ "$pid" = "$dev_profile" ] && sel=" selected"
            printf '<option value="%s"%s>%s</option>' "$pid" "$sel" "$p_name"
        done > /tmp/vpn_cgi_dev_select_$$
        profile_select=$(cat /tmp/vpn_cgi_dev_select_$$ 2>/dev/null)
        rm -f /tmp/vpn_cgi_dev_select_$$
    fi

    cat <<EOF
<div class="device">
  <div class="info">
    <div class="hostname" id="name-${safe_mac}">
      ${display_name}
      <span class="edit-btn" onclick="editName('${mac}','${display_name}')">edit</span>
      <span class="del-btn" onclick="confirmDelete('${mac}','${display_name}')">x</span>
    </div>
    <div class="ip">${ip}</div>
    <div class="mac">${mac}</div>
  </div>
  <div class="controls">
    <div class="toggle">
      <span class="label">VPN</span>
      <a class="btn ${vpn_class}" href="?action=${vpn_action}&mac=${enc_mac}">${vpn_text}</a>
    </div>
    <div class="toggle">
      <span class="label">Zapret</span>
      <a class="btn ${zap_class}" href="?action=${zap_action}&mac=${enc_mac}">${zap_text}</a>
    </div>
    <div class="toggle">
      <span class="label">Routing</span>
      <select class="preset-select" onchange="changePreset('${mac}', this.value)">
        <option value="full_vpn"${sel_full}>Full VPN</option>
        <option value="global_except_ru"${sel_global}>Global -RU</option>
      </select>
    </div>
    <div class="toggle">
      <span class="label">Profile</span>
      <select class="preset-select" onchange="changeProfile('${mac}', this.value)">
        ${profile_select}
      </select>
    </div>
  </div>
</div>
EOF
done

rm -f /tmp/vpn_cgi_profile_opts_$$

cat <<'HTMLFOOT'
<div class="footer">VPN/Zapret Manager | Default: VPN ON (Global -RU), DPI OFF</div>
</body>
</html>
HTMLFOOT
